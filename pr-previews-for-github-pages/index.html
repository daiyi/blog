<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta name="description" content="thoughts and ideas and essays by daiyi; unrefined brain-to-internet pipe; public journaling"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@daiyitastic"><meta name="twitter:creator" content="@daiyitastic"><meta name="twitter:description" content="Use Github Actions to create previews on pull requests to your gh-pages-hosted static site, by pushing to a secret subdirectory. What could go wrong??"><meta name="twitter:image" content="https://daiyi.co/blog/pr-previews-for-github-pages/comment-ready-preview.jpg"><meta property="og:url" content="https://daiyi.co/blog/pr-previews-for-github-pages/index.html"><meta property="og:title" content="How to automate previews for Github Pages"><meta property="og:description" content="Use Github Actions to create previews on pull requests to your gh-pages-hosted static site, by pushing to a secret subdirectory. What could go wrong??"><meta property="og:image" content="https://daiyi.co/blog/pr-previews-for-github-pages/comment-ready-preview.jpg"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.png"><link rel="alternate" href="/blog/rss2.xml"><meta name="author" content="daiyi"><meta name="description" content="thoughts and ideas and essays by daiyi; unrefined brain-to-internet pipe; public journaling"><title>How to automate previews for Github Pages &mdash;&nbsp;daiyi</title><link rel="alternate" href="/blog/rss2.xml" title="daiyi" type="application/rss2.xml">
<link rel="stylesheet" href="/blog/css/main.css">
<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/blog/rss2.xml" title="daiyi" type="application/rss+xml">
</head><body><div class="page"><div class="page-content"><div class="box header"><div class="box-content"><h1><a href="/blog/">daiyi</a></h1><div class="nav"><ul><li><a href="https://daiyi.co/blog/archives">archive</a></li><li><a href="https://daiyi.co">about</a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/daiyitastic">twitter</a></li><li><a target="_blank" rel="noopener" href="https://buttondown.email/daiyi">email updates</a></li></ul></div></div></div><div class="box"><article class="post box-content"><header><h1><a href="/blog/pr-previews-for-github-pages/">How to automate previews for Github Pages</a></h1><div class="meta"><span class="date">2021 11 05</span><span class="location">Mammoth Lakes</span></div></header><div class="post-content">
<figure>
    <img src="comment-ready-preview.jpg">
    <figcaption>
    <p><a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews">Source here</a>. Live demo of <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/pull/2">an open PR</a> with a site preview, and <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/pull/1">a closed PR</a> with preview cleaned up.</p>

    </figcaption>
</figure>
<p>I host my website on Github Pages because it’s simple, I don’t need serverside stuff for a humble static website, I’m already in Github all day errday, and it was a top quality option when I set it up a billion technological years ago.</p>
<p>A feature of modern hosting platforms (e.g. Vercel) that I miss with GH Pages is getting automatic site previews on each PR, which is nice for showing other people your WIPs, or (if you’re lone-wolfing it) quickly checking if things are broken without bothering with your local dev server.</p>
<p>So I thought I’d clobber something together using Github Actions and taking advantage of the directory structure of static sites :D</p>
<h2 id="How-it-works"><a class="header-anchor" href="#How-it-works">&gt;</a>How it works</h2>
<p>To publish my website, I use a github action to compile each commit to the <code>main</code> branch, then push that output to the <code>gh-pages</code> branch.</p>
<p>Adding a PR preview is similar: build the site on each commit to a pull request, and push the result to the <code>/pull/&#123;pr-number&#125;</code> folder on the <code>gh-pages</code> branch. This means the preview can be accessed at <code>https://github.io/username/project/pull/&#123;pr-number&#125;</code>. Seems simple enough, right?</p>
<h2 id="Walkthrough"><a class="header-anchor" href="#Walkthrough">&gt;</a>Walkthrough</h2>
<p>The end result is found here (spoiler alert): <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews">https://github.com/daiyi/gh-pages-pr-previews</a>.</p>
<h3 id="Create-a-new-static-site"><a class="header-anchor" href="#Create-a-new-static-site">&gt;</a>Create a new static site</h3>
<p>For this tutorial I’m starting with a fresh <a target="_blank" rel="noopener" href="https://gohugo.io/">Hugo</a> site, but you can use whatever static site generator you fancy.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create new site</span></span><br><span class="line">hugo new site gh-pages-pr-previews</span><br><span class="line"></span><br><span class="line"><span class="comment"># add theme</span></span><br><span class="line"><span class="built_in">cd</span> gh-pages-pr-previews</span><br><span class="line">git init</span><br><span class="line">git submodule add https://github.com/LukasJoswiak/etch.git themes/etch</span><br><span class="line"><span class="built_in">echo</span> theme = \&quot;etch\&quot; &gt;&gt; config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># create a blog post</span></span><br><span class="line">hugo new posts/pr-previews-for-gh-pages.md</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;I am making my website&#x27;</span> &gt;&gt; content/posts/pr-previews-for-gh-pages.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># check that it works at http://localhost:1313/</span></span><br><span class="line">hugo server -D</span><br></pre></td></tr></table></figure>
<h3 id="Host-your-site-on-github-pages-and-automate-deploy-with-github-actions"><a class="header-anchor" href="#Host-your-site-on-github-pages-and-automate-deploy-with-github-actions">&gt;</a>Host your site on github pages and automate deploy with github actions</h3>
<p>Now it’s time to tell Github about it. Create a repo at <a target="_blank" rel="noopener" href="https://github.com/new">https://github.com/new</a> (I initialised it as blank). Then,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create first commit</span></span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;create website&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># push to github</span></span><br><span class="line">git remote add origin https://github.com/YOUR-USERNAME/gh-pages-pr-previews.git</span><br><span class="line">git branch -M main</span><br><span class="line">git push -u origin main</span><br><span class="line"></span><br><span class="line"><span class="comment"># create a github actions workflow</span></span><br><span class="line">mkdir -p .github/workflows</span><br><span class="line">touch .github/workflows/gh-pages.yml</span><br></pre></td></tr></table></figure>
<p>To automate publishing your site to gh pages on every commit to <code>main</code>, add the following to the <code>.github/workflows/gh-pages.yml</code> file then push the change to github (<a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/blob/76af83267a3ed4ff8b53d7b1b16dfce5e1131d7e/.github/workflows/gh-pages.yml">source here</a>):</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/gh-pages.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">github</span> <span class="string">pages</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span> <span class="comment"># deploy main. If your branch is `master`, you&#x27;ll have to replace that throughout this file.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">domain</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;DOMAIN=www.daiyi.co&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span> <span class="comment"># TODO set your custom domain</span></span><br><span class="line">        <span class="comment"># If you&#x27;re using the default github pages url, use this instead:</span></span><br><span class="line">        <span class="comment"># run: echo &quot;DOMAIN=$&#123;&#123; github.actor &#125;&#125;.github.io&quot; &gt;&gt; $GITHUB_ENV</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">website</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">submodules:</span> <span class="literal">true</span> <span class="comment"># fetch the theme</span></span><br><span class="line">          <span class="comment"># you need to set this as an environment env if your repo or any submodules (e.g the theme) is private:</span></span><br><span class="line">          <span class="comment"># token: $&#123;&#123; secrets.PRIVATE_REPO_TOKEN &#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Hugo</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-hugo@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">hugo-version:</span> <span class="string">&quot;0.88.1&quot;</span> <span class="comment"># TODO set this to your hugo version</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">production</span> <span class="string">base</span> <span class="string">URL</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span> <span class="string">&quot;BASE_URL=https://$<span class="template-variable">&#123;&#123; env.DOMAIN &#125;&#125;</span>/$<span class="template-variable">&#123;&#123; github.event.repository.name &#125;&#125;</span>/&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">website</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">hugo</span> <span class="string">--baseURL</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; env.BASE_URL &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">HUGO_ENV:</span> <span class="string">production</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br><span class="line">          <span class="attr">cname:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.DOMAIN</span> <span class="string">&#125;&#125;</span> <span class="comment"># TODO you need to set this if you&#x27;re using a custom domain. Otherwise you can remove it.</span></span><br></pre></td></tr></table></figure>
<p>Once the file is in <code>main</code>, you should see the workflow running in the Actions tab: <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/actions">https://github.com/daiyi/gh-pages-pr-previews/actions</a>.</p>
<p>When that’s done, activate github pages by going to <code>Settings -&gt; Pages</code> and picking the <code>gh-pages</code> branch under “Source”. Click “Save”. Checking “Enforce HTTPS” is recommended.</p>
<p>The github pages site should be live! I am using a custom domain so mine is at <a href="https://daiyi.co/gh-pages-pr-previews/">https://daiyi.co/gh-pages-pr-previews/</a>. The default should look like: <a target="_blank" rel="noopener" href="https://daiyi.github.io/gh-pages-pr-previews/">https://daiyi.github.io/gh-pages-pr-previews/</a>.</p>
<p>If you look at your new site, you’ll see that there’s no posts, because your post was a draft :'D You can make it live by removing <code>draft: true</code> in <code>/content/posts/pr-previews-for-gh-pages.md</code>:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ---</span><br><span class="line"> title: &quot;Pr Previews for Gh Pages&quot;</span><br><span class="line"> date: 2021-11-03T12:45:17-07:00</span><br><span class="line"><span class="deletion">-draft: true</span></span><br><span class="line"> ---</span><br><span class="line"></span><br><span class="line"> I am making my website</span><br></pre></td></tr></table></figure>
<p>If you commit and push this change, you’ll see another github action kick off. It will take a minute for your site to reflect the new content, but if you keep refreshing the post will appear :D</p>
<h3 id="Automate-static-site-previews-on-pull-requests"><a class="header-anchor" href="#Automate-static-site-previews-on-pull-requests">&gt;</a>Automate static site previews on pull requests</h3>
<p>Now we get to the finale. Modify the <code>gh-pages.yml</code> workflow to also compile the site on every commit to a pull request (<a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/blob/03d7b5f656d4c5d6ed40dcf4307a1ffa6bae30a7/.github/workflows/gh-pages.yml">file source here</a>):</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/.github/workflows/gh-pages.yml b/.github/workflows/gh-pages.yml</span></span><br><span class="line"></span><br><span class="line">on:</span><br><span class="line">   push:</span><br><span class="line">     branches:</span><br><span class="line">       - main # deploy main. If your branch is `master`, you&#x27;ll have to replace that throughout this file.</span><br><span class="line"><span class="addition">+  pull_request: # This will publish a site preview on every pull request, and also run the build command to test if the site is broken.</span></span><br><span class="line"></span><br><span class="line"> jobs:</span><br><span class="line">   deploy:</span><br><span class="line">     runs-on: ubuntu-20.04</span><br><span class="line"><span class="addition">+    env:</span></span><br><span class="line"><span class="addition">+      PR_PATH: pull/$&#123;&#123;github.event.number&#125;&#125;</span></span><br><span class="line">     steps:</span><br><span class="line"><span class="addition">+      - name: Comment on PR</span></span><br><span class="line"><span class="addition">+        uses: hasura/comment-progress@v2.2.0</span></span><br><span class="line"><span class="addition">+        if: github.ref != &#x27;refs/heads/main&#x27;</span></span><br><span class="line"><span class="addition">+        with:</span></span><br><span class="line"><span class="addition">+          github-token: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span></span><br><span class="line"><span class="addition">+          repository: $&#123;&#123; github.repository &#125;&#125;</span></span><br><span class="line"><span class="addition">+          number: $&#123;&#123; github.event.number &#125;&#125;</span></span><br><span class="line"><span class="addition">+          id: deploy-preview</span></span><br><span class="line"><span class="addition">+          message: &quot;Starting deployment of preview ⏳...&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">       - name: Set domain</span><br><span class="line">         run: echo &quot;DOMAIN=www.daiyi.co&quot; &gt;&gt; $GITHUB_ENV # TODO set your custom domain</span><br><span class="line">         # If you&#x27;re using the default github pages url, use this instead:</span><br><span class="line">         # run: echo &quot;DOMAIN=$&#123;&#123; github.actor &#125;&#125;.github.io&quot; &gt;&gt; $GITHUB_ENV</span><br><span class="line"></span><br><span class="line">       - name: Checkout website repo</span><br><span class="line">         uses: actions/checkout@v2</span><br><span class="line">         with:</span><br><span class="line">           submodules: true # fetch the theme</span><br><span class="line">           # you need to set this as an environment env if your repo or any submodules (e.g the theme) is private:</span><br><span class="line">           # token: $&#123;&#123; secrets.PRIVATE_REPO_TOKEN &#125;&#125;</span><br><span class="line"></span><br><span class="line">       - name: Setup Hugo</span><br><span class="line">         uses: peaceiris/actions-hugo@v2</span><br><span class="line">         with:</span><br><span class="line">           hugo-version: &quot;0.88.1&quot; # TODO set this to your hugo version</span><br><span class="line"></span><br><span class="line">       - name: Set production base URL</span><br><span class="line">         run: echo &quot;BASE_URL=https://$&#123;&#123; env.DOMAIN &#125;&#125;/$&#123;&#123; github.event.repository.name &#125;&#125;/&quot; &gt;&gt; $GITHUB_ENV</span><br><span class="line"></span><br><span class="line">       - name: Build website</span><br><span class="line">         run: hugo --baseURL &quot;$&#123;&#123; env.BASE_URL &#125;&#125;&quot;</span><br><span class="line">         env:</span><br><span class="line">           HUGO_ENV: production</span><br><span class="line"></span><br><span class="line"><span class="deletion">-      - name: Deploy</span></span><br><span class="line"><span class="addition">+      - name: Deploy if this is the `main` branch</span></span><br><span class="line">         uses: peaceiris/actions-gh-pages@v3</span><br><span class="line"><span class="addition">+        if: github.ref == &#x27;refs/heads/main&#x27;</span></span><br><span class="line">         with:</span><br><span class="line">           github_token: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span><br><span class="line">           publish_dir: ./public</span><br><span class="line">           cname: $&#123;&#123; env.DOMAIN &#125;&#125; # TODO you need to set this if you&#x27;re using a custom domain. Otherwise you can remove it.</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      - name: Set base URL for preview if PR</span></span><br><span class="line"><span class="addition">+        if: github.ref != &#x27;refs/heads/main&#x27;</span></span><br><span class="line"><span class="addition">+        run: echo &quot;BASE_URL=https://$&#123;&#123; env.DOMAIN &#125;&#125;/$&#123;&#123; github.event.repository.name &#125;&#125;/$&#123;&#123; env.PR_PATH&#125;&#125;/&quot; &gt;&gt; $GITHUB_ENV</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      - name: Build PR preview website</span></span><br><span class="line"><span class="addition">+        if: github.ref != &#x27;refs/heads/main&#x27;</span></span><br><span class="line"><span class="addition">+        run: hugo --baseURL &quot;$&#123;&#123; env.BASE_URL &#125;&#125;&quot;</span></span><br><span class="line"><span class="addition">+        env:</span></span><br><span class="line"><span class="addition">+          HUGO_ENV: staging</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      - name: Deploy to PR preview</span></span><br><span class="line"><span class="addition">+        uses: peaceiris/actions-gh-pages@v3</span></span><br><span class="line"><span class="addition">+        if: github.ref != &#x27;refs/heads/main&#x27;</span></span><br><span class="line"><span class="addition">+        with:</span></span><br><span class="line"><span class="addition">+          github_token: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span></span><br><span class="line"><span class="addition">+          publish_dir: ./public</span></span><br><span class="line"><span class="addition">+          destination_dir: $&#123;&#123; env.PR_PATH &#125;&#125; # TODO you need to set this if you&#x27;re using a custom domain. Otherwise you can remove it.</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      - name: Update comment</span></span><br><span class="line"><span class="addition">+        uses: hasura/comment-progress@v2.2.0</span></span><br><span class="line"><span class="addition">+        if: github.ref != &#x27;refs/heads/main&#x27;</span></span><br><span class="line"><span class="addition">+        with:</span></span><br><span class="line"><span class="addition">+          github-token: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span></span><br><span class="line"><span class="addition">+          repository: $&#123;&#123; github.repository &#125;&#125;</span></span><br><span class="line"><span class="addition">+          number: $&#123;&#123; github.event.number &#125;&#125;</span></span><br><span class="line"><span class="addition">+          id: deploy-preview</span></span><br><span class="line"><span class="addition">+          message: &quot;A preview of $&#123;&#123; github.event.after &#125;&#125; is uploaded and can be seen here:\n\n ✨ $&#123;&#123; env.BASE_URL &#125;&#125; ✨\n\nChanges may take a few minutes to propagate. Since this is a preview of production, content with `draft: true` will not be rendered. The source is here: https://github.com/$&#123;&#123; github.repository &#125;&#125;/tree/gh-pages/$&#123;&#123; env.PR_PATH &#125;&#125;/&quot;</span></span><br></pre></td></tr></table></figure>
<p>It’s nice to clean up after ourselves, so create a new github action file <code>.github/workflows/pr-close.yml</code> that deletes previews when PRs are closed (<a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/blob/03d7b5f656d4c5d6ed40dcf4307a1ffa6bae30a7/.github/workflows/pr-close.yml">source here</a>):</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/pr-close.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">delete</span> <span class="string">preview</span> <span class="string">on</span> <span class="string">PR</span> <span class="string">close</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">closed</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">delete_preview:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">PR_PATH:</span> <span class="string">pull/$&#123;&#123;github.event.number&#125;&#125;</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">make</span> <span class="string">empty</span> <span class="string">dir</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mkdir</span> <span class="string">public</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">delete</span> <span class="string">folder</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br><span class="line">          <span class="attr">destination_dir:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.PR_PATH</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Comment</span> <span class="string">on</span> <span class="string">PR</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">hasura/comment-progress@v2.2.0</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github-token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">number:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event.number</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">id:</span> <span class="string">deploy-preview</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&quot;🪓 PR closed, deleted preview at https://github.com/$<span class="template-variable">&#123;&#123; github.repository &#125;&#125;</span>/tree/gh-pages/$<span class="template-variable">&#123;&#123; env.PR_PATH &#125;&#125;</span>/&quot;</span></span><br></pre></td></tr></table></figure>
<p>Let’s test this out on a PR :D</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b pr-previews</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;workflows for PR previews + delete on PR close&quot;</span></span><br><span class="line">git push --set-upstream origin pr-previews</span><br></pre></td></tr></table></figure>
<p>Go to github and open a <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/pull/1">pull request</a> for that branch. A friendly robot will let you know they’re working on your request:</p>

<figure>
    <img src="comment-loading.jpg">
    <figcaption>
    
    </figcaption>
</figure>
<p>The comment will update with preview urls once the preview is ready:</p>

<figure>
    <img src="comment-ready.jpg">
    <figcaption>
    
    </figcaption>
</figure>
<p>Check out the link in the preview. It should contain a site that is exactly like the site at <code>main</code>, since we haven’t made changes to it. If everything looks good, merge that PR, upon which the robots will come in and <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/pull/1#issuecomment-960087228">clean up</a>:</p>

<figure>
    <img src="comment-delete.jpg" caption="bye">
    <figcaption>
    bye
    </figcaption>
</figure>
<p>Here’s a demo of <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/pull/2">an open pull request</a> where I add a new blog post:</p>

<figure>
    <img src="demo.jpg">
    <figcaption>
    
    </figcaption>
</figure>
<p>The preview for that PR: <a target="_blank" rel="noopener" href="https://daiyi.github.io/gh-pages-pr-previews/pull/2/">https://daiyi.github.io/gh-pages-pr-previews/pull/2/</a>.</p>
<p>And the source: <a target="_blank" rel="noopener" href="https://github.com/daiyi/gh-pages-pr-previews/tree/gh-pages/pull/2/">https://github.com/daiyi/gh-pages-pr-previews/tree/gh-pages/pull/2/</a>.</p>
<p>Nice! It works!</p>
<h3 id="Considerations"><a class="header-anchor" href="#Considerations">&gt;</a>Considerations</h3>
<p>I haven’t thought too hard about if this is too jank for a Serious Website™, but it should be fine for low-key stuff like blogs, portfolios, or documentation.</p>
<p>The preview urls shouldn’t interfere with your site unless the <code>/pull</code> subdirectory is already occupied with a web page. And the preview pages also won’t appear on your production sitemap/rss feeds/other generated indeces since the static site generator doesn’t know about it while compiling the production version of the site. If you’re worried about that, it may be prudent to use ENV flags to conditionally toggle off production stuff in the PR preview sites, like web crawler indexing (<code>noindex,nofollow</code>, <code>robots.txt</code>, etc). In my example, I set <code>HUGO_ENV: production</code> for <code>main</code> and <code>HUGO_ENV: staging</code> for PRs. You can look into if your static site generator/theme supports that.</p>
<p>Also I am not compelled to spend the energy to become a workflow configuration language expert and I’m sure it could be written with more elegance, if that is a concept that can be applied to yaml files. Feel free to make a PR and show me how it should be done :D</p>
<p>Let me know if you use this strategy! I found <a target="_blank" rel="noopener" href="https://github.com/adriangb/gh-pages-docs">someone else’s</a> attempt at implementing this idea but thought I’d try my own hand at it (and also completing the “delete preview on PR close” feature). I’m curious if someone else out there wants to make PR previews for gh pages for some weird reason \o/</p>
</div><div class="entry-footer"><div class="signoff"><p><3,</p><p>daiyi</p></div><div class="tags"><ul><li><a href="/blog/categories/software-shit/">software shit</a></li><li><a href="/blog/tags/tutorials/">tutorials</a></li></ul></div><div class="comments"><h2><a href="#comments" id="comments">Comments</a></h2><p>No comments at the moment. Hey, you could write one \o/</p><form class="comment-instructions" action="https://comment-pr.vercel.app/api" method="post"><h3>Take me to comment town</h3><p>Mica and I love to read your comments. It's easy to write one</p><label for="name">Name*<input type="text" name="name" placeholder="Mica" required></label><label for="url">Website/social URL<input type="text" name="url" placeholder="https://www.strava.com/athletes/64615462"></label><label for="color">Accent color (hex code or html color  name)<input type="text" name="color" placeholder="#00ff7f or springgreen"></label><input type="hidden" name="path" value="source/_posts/pr-previews-for-github-pages/_comments.yaml"><label for="comment">Comment*<textarea placeholder="" name="comment" required></textarea></label><button type="submit">Submit</button></form></div></div></article></div></div><footer><div class="box-content"><nav><ul><li><a href="https://daiyi.co/blog/rss2.xml">rss</a></li><li><a href="https://daiyi.co/blog/archives">archive</a></li></ul><div><form action="https://buttondown.email/api/emails/embed-subscribe/daiyi" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/daiyi', 'popupwindow')">
<label for="bd-email" class="hidden">Get email updates</label>
<input type="email" name="email" id="bd-email" placeholder="Get email updates" />
<input type="hidden" value="1" name="embed" />
<button type="submit">Subscribe</button>
</form></div></nav></div></footer></div></body></html>